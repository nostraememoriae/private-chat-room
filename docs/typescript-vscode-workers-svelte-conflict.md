# TypeScript: VS Code Errors vs Clean `tsc` — Root Cause & Fix

## The Symptom

`bunx tsc --noEmit` produces **zero errors** for `src/totp.ts`.  
VS Code's IntelliSense shows **three persistent errors** on the same file, even after restarting the TS server:

```
TS2769 — No overload matches this call (crypto.subtle.importKey)
  Argument of type 'Uint8Array<ArrayBufferLike>' is not assignable to 'BufferSource'

TS2345 — Argument of type 'Uint8Array<ArrayBufferLike>' is not assignable to 'BufferSource'
  (crypto.subtle.sign)

TS2339 — Property 'timingSafeEqual' does not exist on type 'SubtleCrypto'
```

---

## Why `tsc` and VS Code Disagree

### The CLI (`tsc`)

`tsc` respects `tsconfig.json` exactly. The root config has:

```jsonc
{
  "compilerOptions": {
    "lib": ["ESNext"]
  }
}
```

With only `ESNext`, the type environment is:
- `worker-configuration.d.ts` (generated by `wrangler types`) provides all Workers globals
- Its `SubtleCrypto` is a custom `abstract class` that includes `timingSafeEqual`
- Its `BufferSource` is `ArrayBufferView | ArrayBuffer` (non-generic)

Everything resolves correctly. No errors.

### VS Code's Language Server

VS Code loads **every** tsconfig in the workspace simultaneously. This project has both:

- `tsconfig.json` — Workers/backend, `lib: ["ESNext"]`
- `frontend/tsconfig.json` — Svelte frontend, no explicit `lib` (defaults to `DOM, DOM.Iterable, ESNext`)

Additionally, the **Svelte language server** loads `svelte/svelte-html.d.ts` for HTML element type completions. This file contains:

```typescript
/// <reference lib="dom" />
```

This directive unconditionally injects the full DOM type library into VS Code's shared TypeScript language service — regardless of which tsconfig the file belongs to.

### The Collision

Once DOM is in scope, TypeScript has **two competing definitions** of `SubtleCrypto`:

| Source | Type | Has `timingSafeEqual`? |
|--------|------|----------------------|
| `worker-configuration.d.ts` | `abstract class SubtleCrypto` | ✅ Yes |
| `lib.dom.d.ts` (via Svelte LS) | `interface SubtleCrypto` | ❌ No |

TypeScript merges declarations across all loaded files. The DOM `interface SubtleCrypto` merges on top of the Workers `abstract class SubtleCrypto`, and the DOM version wins for method signatures — dropping `timingSafeEqual`.

Similarly, `Uint8Array<ArrayBufferLike>` (inferred by TypeScript 5.7+ when constructing `new Uint8Array(n)`) does not satisfy DOM's `ArrayBufferView<ArrayBuffer>` because `ArrayBufferLike = ArrayBuffer | SharedArrayBuffer`, and `SharedArrayBuffer` is not assignable to `ArrayBuffer`.

### Why `tsc` doesn't see this

`tsc` runs in isolation with only `lib: ["ESNext"]`. The Svelte LS's `/// <reference lib="dom" />` injection only happens inside the VS Code language service process — it never affects the CLI.

---

## Why Previous Attempts Failed

| Attempt | Why It Didn't Work |
|---------|-------------------|
| Add `"WebWorker"` to `lib` | Adds another `SubtleCrypto` definition, makes collision worse |
| Add `"@cloudflare/workers-types"` to `types` | `timingSafeEqual` already in `worker-configuration.d.ts`; doesn't prevent DOM injection |
| Remove `"types": ["hono"]` from tsconfig | Had no effect; `types` field doesn't control Svelte LS behavior |
| Add `svelte.tsconfig.path` to `.vscode/settings.json` | Svelte LS still loads `svelte-html.d.ts` unconditionally regardless |
| TypeScript project references (`tsconfig.worker.json` + solution file) | In theory correct, but VS Code's language service still loads all tsconfigs together; Svelte LS DOM injection happens at the process level, above project boundaries |

---

## The Fix

Since the Svelte LS's DOM injection cannot be blocked at the config level, the fix is to make `src/totp.ts` **type-safe against DOM being present**.

### 1. Explicit `Uint8Array<ArrayBuffer>` on all Web Crypto allocations

When DOM is loaded, `new Uint8Array(n)` infers `Uint8Array<ArrayBufferLike>` which doesn't satisfy `ArrayBufferView<ArrayBuffer>`. Constructing via an explicit `ArrayBuffer` forces the correct generic:

```typescript
// Before — infers Uint8Array<ArrayBufferLike>, fails under DOM
const output = new Uint8Array(Math.floor((clean.length * 5) / 8))
const bytes = new Uint8Array(8)

// After — explicitly Uint8Array<ArrayBuffer>, correct for Web Crypto
const output = new Uint8Array<ArrayBuffer>(new ArrayBuffer(Math.floor((clean.length * 5) / 8)))
const bytes = new Uint8Array<ArrayBuffer>(new ArrayBuffer(8))
```

Return types and parameter types annotated accordingly:

```typescript
function base32Decode(input: string): Uint8Array<ArrayBuffer>
function counterToBytes(counter: number): Uint8Array<ArrayBuffer>
async function hotp(secretBytes: Uint8Array<ArrayBuffer>, counter: number): Promise<string>
let secretBytes: Uint8Array<ArrayBuffer>
```

This is also more semantically correct: Web Crypto APIs don't support `SharedArrayBuffer`, so `Uint8Array<ArrayBuffer>` accurately reflects the runtime constraint.

### 2. Cast `crypto.subtle` for `timingSafeEqual`

`timingSafeEqual` is a [Cloudflare Workers extension](https://developers.cloudflare.com/workers/runtime-apis/web-crypto/) to `SubtleCrypto` not present in any standard type library. When DOM's `SubtleCrypto` interface is merged in, the method disappears. A targeted cast documents this explicitly:

```typescript
// timingSafeEqual is a Cloudflare Workers extension not present in standard DOM SubtleCrypto types
return (crypto.subtle as unknown as { timingSafeEqual(a: ArrayBuffer, b: ArrayBuffer): boolean })
  .timingSafeEqual(hashA, hashB)
```

---

## Background: `"types"` Field in `tsconfig.json`

The `"types"` field restricts which `@types/*` packages are auto-included as globals:

```jsonc
// Without "types": TypeScript auto-includes all @types/* in node_modules/@types/
// With "types": ["hono"]: only hono's global types are loaded

"types": ["hono"]
```

This project previously had `"types": ["hono"]` alongside `"jsx": "react-jsx"` and `"jsxImportSource": "hono/jsx"` — a leftover from before the Svelte migration. Those were removed since the Workers source (`src/`) uses no JSX.

The `"types"` field does **not** affect the Svelte language server's `/// <reference lib="dom" />` injection, which operates at the VS Code process level.

---

## Final Config State

**`tsconfig.json`** (Workers/backend):
```jsonc
{
  "compilerOptions": {
    "target": "ESNext",
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "strict": true,
    "skipLibCheck": true,
    "lib": ["ESNext"]
  },
  "include": ["*.ts", "src/**/*.ts"]
}
```

**`frontend/tsconfig.json`** (Svelte frontend):
```jsonc
{
  "compilerOptions": {
    "target": "ESNext",
    "useDefineForClassFields": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "noEmit": true,
    "verbatimModuleSyntax": true
  },
  "include": ["src/**/*.ts", "src/**/*.svelte"]
}
```

The frontend tsconfig intentionally has no explicit `lib` — Svelte's LS provides DOM types regardless, so declaring them explicitly would be redundant. The Workers tsconfig will never be contaminated at CLI level; only the VS Code UI is affected, and that is handled by the explicit types in the source.
